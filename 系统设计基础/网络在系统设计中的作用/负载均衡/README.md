<!--
 * @Author: shgopher shgopher@gmail.com
 * @Date: 2024-09-15 17:04:03
 * @LastEditors: shgopher shgopher@gmail.com
 * @LastEditTime: 2024-09-21 23:35:58
 * @FilePath: /luban/系统设计基础/网络在系统设计中的作用/负载均衡/README.md
 * @Description: 
 * 
 * Copyright (c) 2024 by shgopher, All Rights Reserved. 
-->
# 负载均衡
一共分为七层网络模型，分别是

- 7 应用层：http
- 6 表达层
- 5 会话层
- 4 传输层：tcp
- 3 网络层：ip
- 2 数据链路层：wifi
- 1 物理层：物理网卡

## 四层负载均衡
四层负载均衡的意思是指的是这些负载均衡的工作模式特点是维持同一个 tcp 连接，并不是第四层的负载均衡，但是其实做负载均衡的是在第二层和第三层
### 二层
数据链路层传输的内容是数据帧，我们这里讨论的是以太网帧，其中以太网帧还有很多的数据，我们关注 MAC 目标地址和 Mac 源地址，每一块网卡都有一个专属直接的 Mac 地址，以太帧会告诉交换机此连接从哪个网卡来的到哪个网卡去的。

链路层要做的转发就是将目标帧的 MAC 地址给修改了，对于三层来说，根本察觉不到，这才是真的转发，而不是代理

只要真实服务器的 ip 地址保证跟数据包中的 ip 地址一致，数据就可以被转发

我们要做的就是将真实物理服务器所在的虚拟 ip 地址配置成跟负载均衡器的虚拟 ip 一致即可
> 虚拟 IP 地址的实现方式通常是通过软件来进行配置和管理。例如，在网络设备、服务器操作系统或者负载均衡软件中，可以设置虚拟 IP 地址，并将其与特定的服务或应用程序关联起来。同时，虚拟 IP 地址也需要与网络基础设施进行配合，确保数据包能够正确地路由到对应的服务器上。

这种转发叫做三角模式，因为响应就不需要经过转发器了

二层负载均衡器有个缺点就是只能在**一个子网中使用**，因为它是修改的 mac 地址，这就说明它与真实的服务器通信必须是二层可达的状态。
### 三层
以 ip 协议为例，ip 协议包括 headers 和 payload，其中我们只关注 headers 中的源 ip 和目标 ip

三层负载均衡有两种转发模式

第一种，保持原来的数据包不变，新创建一个包，将原来包的 headers 和 payload 作为另外新包的 Payload 内容，在新包的 headers 中写入真实的服务器 ip 作为目标 ip，然后在达到目标服务器之后，再进行拆包动作

这种模式仍必须通过专门的配置，必须保证所有的真实服务器与均衡器有着相同的虚拟 IP 地址

NAT 模式：也可以直接替换 header 中的目标 ip，不过这样的话，这个转发器就不能取消了，必须充当中间人的身份了，服务器返回的内容中源 ip，客户端可不认识啊。客户端只认识中间的转发器，所以不能取消

还有一种更加彻底的 NAT 模式：即均衡器在转发时，不仅修改目标 IP 地址，连源 IP 地址也一起改了，源地址就改成均衡器自己的 IP，但是这样有一些需要根据目标 IP 进行控制的业务逻辑就无法进行
## 七层负载均衡
只有二三层属于数据的转发，到 tcp 之后都属于代理，因为 tcp 协议之后的内容都已经到了目标服务器了，是无法再进行转发数据的。

转发是指的【用户】【四层负载均衡】【服务器】之间是一个通道，代理是用户和七层负载均衡一个通道，七层负载均衡和服务器之间一个通道

### 七层负载均衡的能力
- 静态资源缓存，协议升级，安全防护，访问控制，这种 cdn 能做到的事，七层负载均衡也可以做到，毕竟都是加一层保护膜对吧
- 可以实现更加智能，更加多样的路由
- 使用反向代理去防止攻击
- 微服务中的链路治理都需要在七层负载均衡中去做 (通常是 API 网关，nginx 也算 api 网关但是跟专业的比治理方面功能性差很多) 比如服务降级，熔断，异常注入等内容
### 负载均衡算法
- 轮询
- 权重轮询，就是虚拟化服务器，权重大的服务器数量上就会变多
- 随机
- 权重随机
- 一致性哈希，其实就是权重轮询，但是环形结构，只有在环形结构上与该节点相邻的部分数据需要进行重新分配，而不是像传统哈希算法那样需要对所有数据进行重新计算和分配。
- 响应速度均衡，根据服务器响应时间，将请求分配到响应时间快的服务器上
- 最少连接，将请求分配到连接数最少的服务器上
### nginx 实现七层负载均衡器


