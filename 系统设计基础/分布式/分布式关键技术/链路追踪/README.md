# 分布式链路追踪系统

一个链路追踪系统最重要的部分就是数据收集系统，然后还搭配着数据存储和数据展示的功能，当然你可以狭义的认为链路追踪系统就是数据收集系统也可以，不过通常一个链路追踪系统或者也叫做 APM 系统 (应用性能管理)
是包含了收集存储和展示的广义分布式链路追踪系统

**从客户端的请求到达系统的边界开始，记录该请求流进的每一个服务，直到客户端的响应返回，这就是一个完整的链路追踪 (Trace)。**


**每次 Trace 都可能会调用数量不同、不同类型的的多个服务，那么为了能够记录具体调用了哪些服务，以及调用的顺序、开始时间、执行时长等信息，每次开始调用服务前，系统都要先埋入一个调用记录，这个记录就叫做一个跨度 (Span)**


这是链路追踪最大的两个基本概念 **“追踪”** **“跨度”**

一般来说，每一次的 Trace 都是由若干个具有非线性关系且具有嵌套关系的 Span 组成的树状结构，你说有没有是线性关系的 span？应该也有。
![trace-spans](trace-spans.png)

链路追踪的目的主要有两个**故障定位和分析性能**

只要整理好每一个 trace 中各个 span 的调用关系，响应耗时和响应结果，就能定位出错误和性能。通常我们会绘制出来一个 trace 的 span 拓扑图，比如 go 语言的 [pprof](https://github.com/google/pprof) 工具就可以绘制出来一个 trace 的 span 拓扑图，这样就能直观的看到整个系统的调用关系，以及每个 span 的耗时，pprof 中的火焰图非常直观的能分析出性能问题。

如果把此次 trace 的数据跟往期对比，大概就能横向对比出整个系统的性能走向了。

trace 在实现上有以下四个难点，或者说必须突破的点：
- 必须**低损耗**，不能影响业务
- **对应用本身是透明**的，不能干涉业务代码，通常链路追踪都是运维在后期加入的，不能直接在业务代码中写进去
- 要求**自动扩容**，跟随应用的扩容而扩容
- **持续监控**，要求 24 小时不间断的监控整个系统。

## 链路追踪数据收集的三种方法
### 基于日志的追踪
### 基于服务的追踪
### 基于服务网格中边车代理的追踪






